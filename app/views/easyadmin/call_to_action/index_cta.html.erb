<%= render partial: "/easyadmin/easyadmin/left_bar", locals: { page: "calltoaction" } %>
 
  <div id="content">    
    
    <div id="content-header">
      <h1>Elenco CALLTOACTION</h1>
    </div> <!-- #content-header --> 

    <div id="content-container">

   	<ul class="nav nav-tabs">
      <li class="active"><a href="/easyadmin/cta">Elenco</a></li>
      <li><a href="/easyadmin/cta/template">Template</a></li>
	</ul>

    	<% if flash[:notice] %>
	    	<div class="row">
		      <div class="col-md-12">         
		          <div class="row">
		            <div class="col-lg-12">
		              <div class="alert alert-success"><%= flash[:notice] %></div>
		            </div>
		          </div>
		        
		      </div>
		    </div>
	    <% end %>

	    <div class="row text-right">
	    	<div class="col-md-12">
	    		<a href="/easyadmin/cta/new"><button type="button" class="btn btn-primary">NUOVA</button></a>
	    	</div>
	    </div>

	    <div class="row">
	    	<div class="col-md-3">
	    		<label>Filtra per TITOLO</label><input class="form-control" type="text" onkeyup="updateFilter(0, this);">
	    	</div>
	    	<div class="col-md-3">
	    		<label>Filtra per TAG</label><input class="form-control" type="text" onkeyup="updateFilter(1, this);">
	    	</div>
	    </div>

	    <div id="cta-to-filter" class="row hidden">
				<div class="col-md-12"> 
					<table id="cta-from-ajax-request" class="table table-striped">
					</table>
				</div>
			</div>

		<div class="row cta-to-show">
			<div class="col-md-12"> 
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Titolo</th>
							<th class="hidden-xs hidden-sm">Data attivazione</th>
							<th>TAG</th>
							<th>Padre</th>
							<th>Immagine</th>
							<th>Azioni</th>
						</tr>
					</thead>
					<% @cta_list.each do |calltoaction| %>
						<%= render partial: "/easyadmin/call_to_action/index_row", locals: { calltoaction: calltoaction } %>
					<% end %>
				</table>
			</div>
		</div>

		<div class="row cta-to-show">
			<div class="col-md-12">
				<%= render partial: "/easyadmin/easyadmin/pagination" %>
			</div>
		</div>

	</div>
</div>

<script type="text/javascript">
	function hideCalltoaction(id){
		$.ajax({
            type: "POST",
            url: "/easyadmin/cta/hide/" + id,
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
            },
            success: function(data) {
            	if(data == "active") 
            		$("#eye-" + id).css("color", "red");
            	else
            		$("#eye-" + id).css("color", "gray");
            }
        });
	}

	var ajax_in_progress = false;
	var filters = ["", ""];

	function updateFilter(n, filter) {
		filters[n] = $(filter).val();
		console.log(filters[n]);
		updateCtaToFilters(filters);
	}

	function updateCtaToFilters(filters) {
		if(filters[0] == "" && filters[1] == "") {

			$(".cta-to-show").removeClass("hidden");
			$("#cta-to-filter").addClass("hidden");

		} else {

			$(".cta-to-show").addClass("hidden");
			$("#cta-to-filter").removeClass("hidden");

				if(!ajax_in_progress) {

				ajax_in_progress = true;
				var urlString = "";

				if(filters[0] == "")
					urlString = "cta/filter/nil_title_filter/" + filters[1];
				else if(filters[1] == "")
					urlString = "cta/filter/" + filters[0] + "/nil_tag_filter";
				else
					urlString = "cta/filter/" + filters[0] + "/" + filters[1];

				$.ajax({
	            type: "GET",
	            url: urlString,
	            beforeSend: function(jqXHR, settings) {
	                jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
	            },
	            success: function(data) {

								$("#cta-from-ajax-request").html("");

	            	$("#cta-from-ajax-request").html(data);

	            	html =
	            				"<thead>" +
												"<tr>" +
													"<th>Titolo</th>" +
													"<th class=\"hidden-xs hidden-sm\">Data attivazione</th>" +
													"<th>TAG</th>" +
													"<th>Padre</th>" +
													"<th>Immagine</th>" +
													"<th>Azioni</th>" +
												"</tr>" +
											"</thead>";

								$("#cta-from-ajax-request").prepend(html);

								ajax_in_progress = false;

	            },
	            error: function(data) {
	            	ajax_in_progress = false;
	            }
	        });
				}

		}
   }

</script>