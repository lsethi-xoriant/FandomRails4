<%= render partial: "/easyadmin/easyadmin/left_bar", locals: { page: "calltoaction" } %>
 
  <div id="content">    
    
    <div id="content-header">
      <h1>CONTENUTI GENERATI DAGLI UTENTI</h1>
    </div> <!-- #content-header --> 

      <div id="content-container">

      <% if flash[:notice] %>
        <div class="row">
          <div class="col-md-12">         
              <div class="row">
                <div class="col-lg-12">
                  <div class="alert alert-success"><%= flash[:notice] %></div>
                </div>
              </div>
          </div>
        </div>
      <% end %>

      <ul class="nav nav-tabs">
      <li class="active"><a href="/easyadmin/cta/to_approve">Contenuti da approvare</a></li>
      <li><a href="/easyadmin/cta/approved">Contenuti pubblicati</a></li>
      <li><a href="/easyadmin/cta/not_approved">Contenuti oscurati</a></li>
    </ul>

    <h3>Contenuti da moderare</h3>
    <hr/>

    <%= form_tag :action => 'filter_ugc', :approvation_status => 'to_be_approved', :method => 'post' do %>
      <%= render partial: "/easyadmin/call_to_action/user_cta_search_tab" %>
    <% end %>

    <div class="row cta-to-show">
      <div class="col-md-12"> 
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Titolo</th>
              <th>Slug</th>
              <th class="hidden-xs hidden-sm">Data immissione</th>
              <th>Utente</th>
              <th>Tags</th>
              <th>Thumbnail</th>
              <th>Liberatoria</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <% @ctas.each do |c| %>
            <tr id="cta-<%= c.id %>">
              <td class="col-md-2"><%= c.title %></td>
              <td class="col-md-1"><%= c.slug %></td>
              <td class="hidden-xs hidden-sm col-md-1"><%= c.created_at.strftime("%d/%m/%Y %H:%M") %></td>
              <td class="col-md-2"><%= "#{c.user.username}" %> <br/> <%= "(#{c.user.email})" %></td>
              <td class="col-md-1">
                <%= (c.call_to_action_tags.map { |ctatag| ctatag.tag.name }).join(", ") %>
              </td>
              <td class="col-md-1">
                <% if c.media_image.present? %>
                  <% if c.media_image.content_type.start_with?("image") %>
                    <img src="<%= c.media_image.url(:extra) %>" class="img-responsive" style="max-width: 200px; width: 100%;">
                  <% elsif !c.media_image.content_type.start_with?("video") %>
                    <a href="<%= c.media_image.url %>" target="_blank">scarica</a>
                  <% elsif aws_trasconding_not_required_or_completed(c) %>
                    <a href="<%= c.media_image.url %>"><i class="fa fa-play-circle-o fa-2x" style="color:red"></i></a>
                  <% end %>
                <% end %>
              </td>
              <td class="col-md-1">
                <% if c.releasing_file.present? && c.releasing_file.file.present? %>
                  <% if c.releasing_file.file_content_type.split("/").first == "image" %>
                    <img src="<%= c.releasing_file.file.url %>" class="img-responsive" style="max-width: 200px; width: 100%;">
                  <% elsif c.releasing_file.file_content_type.split("/").first != "image" %>
                    <a href="<%= c.releasing_file.file.url %>" target="_blank">scarica</a>
                  <% else %>
                    --
                  <% end %>
                <% end %>
              </td>
              <td class="col-md-3">
                <% if aws_trasconding_not_required_or_completed(c) %>
                  <button type="button" class="btn btn-success btn-xs" onclick="updateCta(true, <%= c.id %>)">Approva</button>
                  &nbsp;&nbsp;
                  <button type="button" class="btn btn-primary btn-xs" onclick="updateCta(false, <%= c.id %>)">Rifiuta</button>
                  &nbsp;&nbsp;
                  <a href="/easyadmin/cta/edit/<%= c.id %>">
                    <button type="button" class="btn btn-secondary btn-xs">Edita</button>
                  </a> 
                <% else %>
                  <p>aws transconding status: <%= @aws_transcoding_media_status %></p>
                <% end %>           
              </td>       
              </tr>
          <% end %>
        </table>
      </div>
    </div>

    <div class="row cta-to-show">
      <div class="col-md-12">
        <%= render partial: "/easyadmin/easyadmin/pagination" %>
      </div>
    </div>

  </div>
</div>

<script type="text/javascript">
  function updateCta(approved, cta_id) {
    $("#cta-" + cta_id).remove();
    $.ajax({
            type: "POST",
            url: "/easyadmin/cta/" + cta_id + "/update_cta_status",
            data: { "approved": approved },
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
            },
            success: function(data) {
              $("#cta-" + cta_id).remove();
            }
        });
  }
</script>