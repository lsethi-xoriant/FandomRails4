<%= render partial: "/easyadmin/easyadmin/left_bar", locals: { page: "tags" } %>
    
<div id="content">    

  <div id="content-header">
    <h1>Modifica TAG</h1>
  </div> <!-- #content-header --> 

  <div id="content-container">

    <div class="row">
      <div class="col-md-12"> 
        <% if @tag.errors.any? %>
          <div class="row">
            <div class="col-lg-12">
              <div class="alert alert-danger">
                <p>Errori nel salvataggio del tag:</p>
                <p>
                  <ul>
                    <% @tag.errors.full_messages.each do |msg| %>
                      <li><%= msg %></li>
                    <% end %>
                  </ul>
                </p>
              </div>
            </div>
          </div>
        <% elsif flash[:notice] %>
          <div class="row">
            <div class="col-lg-12">
              <div class="alert alert-success"><%= flash[:notice] %></div>
            </div>
          </div>
        <% elsif flash[:error] %>
          <div class="row">
            <div class="col-lg-12">
              <div class="alert alert-danger"><%= flash[:error] %></div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <h3>Dati generali</h3>
    <hr/>

    <%= form_for @tag, url: "/easyadmin/tag/#{@tag.id}", multipart: true do |f| %>
      <div class="row">
        <div class="col-lg-6">
          <div class="form-group">
              <label class="text-input">Titolo</label>
              <%= f.text_field :name, :class => "form-control", :readonly => true %>
          </div>
          <div class="form-group">
              <label class="text-input">Descrizione</label>
              <%= f.text_area :description, :class => "form-control", rows: 5 %>
          </div>

        </div>

        <div class="col-sm-6">
	    	<label class="text-input">Tags correlati</label>
      			<%= render_html_tag_box("tag_list", @tag_list, "Nuovi tag verranno creati.") %>
      			<span class="help-block">Per separare i TAG digita virgola</span>
      			<p id="tag_list_message"> </p>
	    </div>

      </div>

      <div class="row">
      	<div class="col-lg-12">
            <label>METADATI</label>
            <p style="float: right;">
              <%= link_to_add_tag_fields "AGGIUNGI METADATO", f, :tag_fields %>
            </p>             
            <hr style="margin-top: 10px; margin-bottom: 10px;" />

            <div id="tmp-tagfield-add"></div>

            <%= f.fields_for :tag_fields do |builder| %>
            	<% if @tag.tag_fields.count > 0 %>
            		<%= render 'tag-field-form', :f => builder %>
            	<% end %>
            <% end %>

          </div>
      </div>

      <h3>Data inizio validità</h3>
      <hr/>

      <div class="row">
        <div class="col-lg-6">
          <div class="form-group">
            <label class="text-input">Giorno</label>
            <div id="calltoaction_activation_date_div" class="input-group date" data-auto-close="true" data-date-autoclose="true" data-date-format="yyyy-mm-dd">
              <%= f.text_field :valid_from_date, :class => "form-control", value: @tag && @tag.valid_from ? @tag.valid_from.in_time_zone("Rome").strftime("%Y-%m-%d") : "" %>
              <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="form-group">
            <label class="text-input">Ora</label>
            <div id="dp-ex-3" class="input-group bootstrap-timepicker">
              <%= f.text_field :valid_from_time, :class => "form-control", value: @tag && @tag.valid_from ? @tag.valid_from.in_time_zone("Rome").strftime("%H:%M") : DateTime.now.strftime("%H:%M") %>
              <span class="input-group-addon"><i class="fa fa-clock-o"></i></span>
            </div>
          </div>
        </div>
      </div>
      
      <h3>Data fine validità</h3>
      <hr/>

      <div class="row">
        <div class="col-lg-6">
          <div class="form-group">
            <label class="text-input">Giorno</label>
            <div id="calltoaction_activation_date_div" class="input-group date" data-auto-close="true" data-date-autoclose="true" data-date-format="yyyy-mm-dd">
              <%= f.text_field :valid_to_date, :class => "form-control", value: @tag && @tag.valid_to ? @tag.valid_to.in_time_zone("Rome").strftime("%Y-%m-%d") : "" %>
              <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="form-group">
            <label class="text-input">Ora</label>
            <div id="dp-ex-3" class="input-group bootstrap-timepicker">
              <%= f.text_field :valid_to_time, :class => "form-control", value: @tag && @tag.valid_to ? @tag.valid_to.in_time_zone("Rome").strftime("%H:%M") : "" %>
              <span class="input-group-addon"><i class="fa fa-clock-o"></i></span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
		<div class="col-lg-12">
			<div class="form-group">								
		  		<%= f.check_box :locked %> LOCKED
			</div>
		</div>
      </div>
      <div class="row text-center">
        <div class="col-sm12">
          <button type="submit" class="btn btn-primary btn-lg">SALVA</button>
        </div>
      </div>     
    <% end %>
    </div>
    
</div>

<script type="text/javascript">

  tl = <%= raw(Tag.select("name").where("valid_to IS NULL OR valid_to > now()").map(&:name).to_json) %>;
  $(document).ready(function() {
    $('#s2_tokenization').select2({
      placeholder: "",
      tags: tl,
      tokenSeparators: [","]
    });
    
    <% if @cloning %>
    	$("#tag_name").focus();
    <% end %>
    
  });

  function add_tag_fields(link, association, content) {
    var new_id = new Date().getTime();
    var regexp = new RegExp("new_" + association, "g");
    $("#tmp-tagfield-add").prepend(content.replace(regexp, new_id));
  }

  function remove_tag_fields(link) {
    $(link).parent().parent().parent().remove();
  }

</script>