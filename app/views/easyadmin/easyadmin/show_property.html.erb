<%= render partial: "/easyadmin/easyadmin/left_bar", locals: { page: "property" } %>

<div id="content">   

  <div id="content-header">
    <h1>PROPERTY <%= @current_prop.name %></h1>
  </div> <!-- #content-header --> 

  <div id="content-container">

    <% if flash[:notice] %>
      <div class="row">
        <div class="col-md-12"> 
          <div class="row">
            <div class="col-lg-12">
              <div class="alert alert-success"><%= flash[:notice] %></div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <ul id="property-tab" class="nav nav-tabs">
        <li class="active"><a href="#dati-generali-tab">Dati generali</a></li>
      <li><a href="#livelli-tab">Livelli</a></li>
      <li><a href="#badges-tab">Badges</a></li>
    </ul>

    <div class="tab-content">
      <div id="dati-generali-tab" class="tab-pane fade in active">
        <h3>Dati generali <a style="float:right" href="/easyadmin/property/edit/<%= @current_prop.id %>" class="btn btn-primary">MODIFICA</a></h3>
        <hr/>
        
        <div class="row">
          <div class="col-lg-4">
              <dl class="dl-horizontal">
                <dt>Nome</dt><dd><p><%= @current_prop.name %></p></dd>
                <dt>Descrizione</dt><dd><p><%= @current_prop.description %></p></dd>
                <dt>Attivazione</dt><dd><p><%= @current_prop.activated_at.blank? ? "NON ATTIVA" : @current_prop.activated_at %></p></dd>
                <dt>Codice colore</dt>
                  <dd><p><%= @current_prop.color_code %><div style="border-radius: 5px; width: 20px; height: 20px; background-color: <%= @current_prop.color_code %>;"></div></p></dd>
                <dt>CTA agganciate</dt><dd><p><%= @current_prop.calltoactions.count %></p></dd>
                <dt>Utenti registrati</dt><dd><p><%= @current_prop.rewarding_users.count %></p></dd>
              </dl>
          </div>
          <div class="col-lg-8">
            <dl class="dl-horizontal">
              <dt>Sfondo</dt><dd><p><img src="<%= @current_prop.background.url %>" style="max-width: 300px; border: 1px solid black; border-radius: 10px;"></p></dd>
            </dl>
          </div>
        </div> 

        <% unless @current_prop.rewarding_users.blank? %>
          <div class="row">
            <div class="col-md-12">
              <div class="portlet">
                <div class="portlet-header">
                  <h3>
                    <i class="fa fa-bar-chart-o"></i>
                    UTENTI REGISTRATI NELL PROPERTY
                  </h3>
                </div> <!-- /.portlet-header -->
                <div class="portlet-content">
                  <div id="line-chart" class="chart-holder"></div>              
                </div> <!-- /.portlet-content -->
              </div> <!-- /.portlet -->         
            </div> <!-- /.col -->
          </div>
        <% end %>

      </div>

      <div id="livelli-tab" class="tab-pane fade">
        <h3>LIVELLI  <a style="float: right" href="/easyadmin/property/show/<%= @current_prop.id %>/new_level" class="btn btn-primary">NUOVO LIVELLO</a></h3>
        <hr/>
          
        <div class="row">
          <div class="col-lg-12">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Limite in punti</th>             
                  <th>Assegnati</th>
                  <th>Immagine</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <% @current_prop.levels.each do |l| %>
                <tr>
                  <td><%= l.name %></td>
                  <td><%= l.points %></td>
                  <td><%= l.user_levels.count %></td>
                  <td>
                    <% unless l.image.blank? %>
                      <img src="<%= l.image.url %>" class="img-responsive" style="max-width: 200px;">
                    <% end %>
                  </td>
                  <td id="td-level-<%= l.id %>">
                    <a href="/easyadmin/property/show/<%= @current_prop.id %>/edit_level/<%= l.id %>"><i class="fa fa-gears" style="color: red"></i></a>
                    &nbsp;&nbsp;
                    <a href="javascript: void(0)" onclick="openDeleteLevelModal(<%= l.id %>, '<%= l.name %>')"><i class="fa fa-ban" style="color: red"></i></a>
                  </td>
                </tr>
              <% end %>
            </table>
          </div>
        </div>
      </div>

      <div id="badges-tab" class="tab-pane fade">
        <h3>BADGE <a style="float:right" href="/easyadmin/property/show/<%= @current_prop.id %>/new_badge" class="btn btn-primary">NUOVO BADGE</a></h3>
        <hr/>

        <div class="row">
          <div class="col-lg-12">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Regola</th>
                  <th>Assegnati</th>
                  <th>Immagine</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <% @current_prop.badges.each do |b| %>
                <tr>
                  <td><%= b.name %></td>
                  <td><%= b.role %> &ge; <%= b.role_value %></td>
                  <td><%= b.user_badges.count %></td>
                  <td>
                    <% unless b.image.blank? %>
                      <img src="<%= b.image.url %>" class="img-responsive" style="max-width: 200px;">
                    <% end %>
                  </td>
                  <td id="td-badge-<%= b.id %>">
                    <a href="/easyadmin/property/show/<%= @current_prop.id %>/edit_badge/<%= b.id %>"><i class="fa fa-gears" style="color: red"></i></a>
                    &nbsp;&nbsp;
                    <a href="javascript: void(0)" onclick="openDeleteBadgeModal(<%= b.id %>, '<%= b.name %>')"><i class="fa fa-ban" style="color: red"></i></a>               
                  </td>
                </tr>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="delete-badge-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="h4-delete-badge-title"></h4>
      </div>
      <div class="modal-body">
        L'eliminazione del badge porterà all'eliminazione di tutte le azioni degli utenti associate. I dati non saranno più recuperabili.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Annulla</button>
        <a href="javascript: void(0)" onclick="deleteBadge();"><button type="button" class="btn btn-danger">Continua</button></a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal --> 

<!-- Modal -->
<div class="modal fade" id="delete-level-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="h4-delete-level-title"></h4>
      </div>
      <div class="modal-body">
        L'eliminazione del livello porterà all'eliminazione di tutte le azioni degli utenti associate. I dati non saranno più recuperabili.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Annulla</button>
        <a href="javascript: void(0)" onclick="deleteLevel();"><button type="button" class="btn btn-danger">Continua</button></a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal --> 

<script src="/canvas-admin/js/libs/raphael-2.1.2.min.js"></script>
<script src="/canvas-admin/js/plugins/morris/morris.min.js"></script>

<script type="text/javascript">
  
  badge_to_delete = -1;
  level_to_delete = -1;

  $(document).ready(function() {
    buildLine();

    $('#property-tab a').click(function (e) {
      e.preventDefault()
      $(this).tab('show')
    })

  });

  user_counter = <%= @current_prop.rewarding_users.blank? ? 0 : @current_prop.rewarding_users.count %>;
  function buildLine() {
    if(user_counter > 0) {

      first_user_created_at = "<%= (@current_prop.rewarding_users.order("created_at ASC").limit(1).first.created_at).strftime("%Y-%m-%d") unless @current_prop.rewarding_users.blank? %>";

      var data_arr = [];

      data_arr.push({ time: first_user_created_at, tot: 0, provider: 0, simple: 0 });

      user_arr = <%= raw(@user_week_list.to_json) %>;
      $.each(user_arr, function(key, value) {
        data_arr.push({
          time: key,
          reg: value
        });
      });
   
      current_time = "<%= Time.now.to_date.strftime("%Y-%m-%d") %>"; 
      current_time_user = <%= @current_prop.rewarding_users.where("created_at<=?", Time.now).count %>;
      data_arr.push({        
          time: current_time,
          reg: current_time_user,
      });
          
      Morris.Line({
        element: 'line-chart',
        data: data_arr,
        xLabelFormat: function (x) { return (x.getMonth() + 1) + "/" + x.getFullYear(); },
        xkey: 'time',
        ykeys: ['reg'],
        labels: ['Registrati'],
        lineColors: ["black", "#0b62a4", "#f18c09"]
      });

    }
  }

  function openDeleteBadgeModal(index, name) {
    badge_to_delete = index;
    $('#h4-delete-badge-title').html("Eliminazione badge: " + name);
    $('#delete-badge-modal').modal('show');
  }

  function deleteBadge() {
    $('#delete-badge-modal').modal('hide');
    $.ajax({
        type: "POST",
        url: '/easyadmin/destroy_badge.json',
        data: { "id": badge_to_delete},
        beforeSend: function(jqXHR, settings) {
            jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
        },
        success: function(data) {
          $('#delete-badge-modal').modal('hide');
          $("#td-badge-" + badge_to_delete).html("cancellato")
          $('#h4-delete-badge-title').html("");
          badge_to_delete = -1;
        },
        error: function(data) {
          badge_to_delete = -1;
          alert("ERRORE");
        }
    })
  } 

  function openDeleteLevelModal(index, name) {
      level_to_delete = index;
      $('#h4-delete-level-title').html("Eliminazione livello: " + name);
      $('#delete-level-modal').modal('show');
  }

  function deleteLevel() {
      $('#delete-level-modal').modal('hide');
      $.ajax({
          type: "POST",
          url: '/easyadmin/destroy_level.json',
          data: { "id": level_to_delete},
          beforeSend: function(jqXHR, settings) {
              jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
          },
          success: function(data) {
            $('#delete-level-modal').modal('hide');
            $("#td-level-" + level_to_delete).html("cancellato")
            $('#h4-delete-level-title').html("");
            level_to_delete = -1;
          },
          error: function(data) {
            level_to_delete = -1;
            alert("ERRORE");
          }
      })
    } 

</script>
