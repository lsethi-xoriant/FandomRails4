<%= render partial: "/easyadmin/easyadmin/left_bar", locals: { page: "calltoaction" } %>
 
  <div id="content">    
    
    <div id="content-header">
      <h1>Elenco CALLTOACTION</h1>
    </div> <!-- #content-header --> 

    	<div id="content-container">

    	<% if flash[:notice] %>
	    	<div class="row">
		      <div class="col-md-12">         
		          <div class="row">
		            <div class="col-lg-12">
		              <div class="alert alert-success"><%= flash[:notice] %></div>
		            </div>
		          </div>
		        
		      </div>
		    </div>
	    <% end %>

	    <div class="row text-right">
	    	<div class="col-md-12">
	    		<a href="/easyadmin/cta/new %>"><button type="button" class="btn btn-primary">NUOVA</button></a>
	    	</div>
	    </div>

	    <div class="row">
	    	<div class="col-md-3">
	    		<label>Filtra per TITOLO</label><input class="form-control" type="text" onkeyup="updateCtaToFilter(this);">
	    	</div>
	    </div>

	    <div id="cta-to-filter" class="row hidden">
			<div class="col-md-12"> 
				<table class="table table-striped" id="filter-table-table">
				</table>
			</div>
		</div>

		<div class="row cta-to-show">
			<div class="col-md-12"> 
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Titolo</th>
							<th class="hidden-xs hidden-sm">Data attivazione</th>
							<th>TAG</th>
							<th>Padre</th>
							<th>Immagine</th>
							<th>Azioni</th>
						</tr>
					</thead>
					<% @cta_list.each do |c| %>
						<tr>
							<td><%= c.title %></td>
							<td class="hidden-xs hidden-sm"><%= c.activated_at.strftime("%d/%m/%Y %H:%M") if c.activated_at %></td>


							<td><%= (c.call_to_action_tags.map { |call_to_action_tag| call_to_action_tag.tag.text }).join(", ") %></td>


							<td><%= (c.answers.map { |answer| answer.quiz.interaction.call_to_action.title }).join(", ") %></td>


							<td>
								<% if c.image.present? %>
									<img src="<%= c.image.url %>" class="img-responsive" style="max-width: 200px; width: 100%;">
								<% end %>
							</td>
							<td>
								<div class="row">

									<div class="col-sm-1" style="margin: 0;">
										<a href="/easyadmin/cta/show/<%= c.id %>"><i class="fa fa-info-circle" style="color: red"></i></a>
									</div>

									<div class="col-sm-1" style="margin: 0;">
										<a href="/easyadmin/cta/edit/<%= c.id %>"><i class="fa fa-pencil-square-o" style="color: red"></i></a>
									</div>

									<div class="col-sm-1" style="margin: 0;">
										<a href="/easyadmin/cta/tag/<%= c.id %>"><i class="fa fa-tag" style="color: red"></i></a>
									</div>

									<div class="col-sm-1" style="margin: 0;">
										<a href="javascript: void(0)" onclick="hideCalltoaction('<%= c.id %>')"><i class="fa fa-eye" style="color: <%= c.activated_at.blank? ? "gray" : "red" %>" id="eye-<%= c.id %>"></i></a>
									</div>

								</div>
							</td>
						</tr>
					<% end %>
				</table>
			</div>
		</div>

		<div class="row cta-to-show">
			<div class="col-md-12">
				<%= render partial: "pagination" %>
			</div>
		</div>

	</div>
</div>

<script type="text/javascript">
	function hideCalltoaction(id){
		$.ajax({
            type: "POST",
            url: "/easyadmin/cta/hide/" + id,
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'));
            },
            success: function(data) {
            	if(data == "active") 
            		$("#eye-" + id).css("color", "red");
            	else
            		$("#eye-" + id).css("color", "gray");
            }
        });
	}

	function updateCtaToFilter(f) {
		if($(f).val().length < 1) {
			$(".cta-to-show").removeClass("hidden");
			$("#cta-to-filter").addClass("hidden");
		} else {
			$(".cta-to-show").addClass("hidden");
			$("#cta-to-filter").removeClass("hidden");
	        $.ajax({
	            type: "POST",
	            url: '/easyadmin/cta/filter/' + $(f).val() + "<%= "/#{ @current_prop }" if @current_prop %>",
	            success: function(data) {
	               fhtml = "<thead><tr><th>Capitolo</th><th>Titolo</th><th>Data attivazione</th><th>Immagine</th><th>Azioni</th></tr></thead>";
	               $.each(data, function(key, value) {
	               	  imghtml = "<img src=\"" + value.image + "\" class=\"img-responsive\" style=\"max-width: 200px;\">";

	               	  actionhtml = 
									"<a href=\"/easyadmin/cta/show/" + key + "\"><i class=\"fa fa-info\" style=\"color: red\"></i></a>&nbsp;&nbsp;" +
									"<a href=\"/easyadmin/cta/edit/" + key + "\"><i class=\"fa fa-gears\" style=\"color: red\"></i></a>&nbsp;&nbsp;" +
									"<a href=\"/easyadmin/cta/tag/" + key + "\"><i class=\"fa fa-tag\" style=\"color: red\"></i></a>&nbsp;&nbsp;";
					  if(value.activated_at != null)
					  	actionhtml += "<a href=\"javascript: void(0)\" onclick=\"hideCalltoaction('" + key + "')\"><i class=\"fa fa-eye\" style=\"color: red\" id=\"eye-" + key + "\"></i></a>";
					  else
					  	actionhtml += "<a href=\"javascript: void(0)\" onclick=\"hideCalltoaction('" + key + "')\"><i class=\"fa fa-eye\" style=\"color: gray\" id=\"eye-" + key + "\"></i></a>";
								
	                  fhtml += 
	                  			"<tr>" + 
	                  			"<td>" + value.propertyname + "</td>" +
	                  			"<td>" + value.title + "</td>" +
	                  			"<td>" + value.activated_at + "</td>" +
	                  			"<td>" + imghtml + "</td>" +
	                  			"<td>" + actionhtml + "</td>" +
	                  			"</tr>";
	               });
	               $("#filter-table-table").html(fhtml);
	            }
	        });
		}
    }

</script>